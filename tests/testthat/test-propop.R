options(cli.default_handler = function(...) { })

# Prepare snapshot 1 region ----

test_that("tests propop: 1 region vs. 5 regions", {

  skip_on_ci()

  ## FSO parameters ----
  # fso_parameters |>
  #   dplyr::filter(age < 51 & year == 2019) |>
  #   constructive::construct()
  parameters_short_1r <- tibble::tibble(
    nat = rep(c("ch", "int"), each = 102L),
    sex = rep(rep(c("m", "f"), 2), each = 51L),
    age = rep(seq(0, 50, by = 1), 4),
    year = rep("2019", 204L),
    scen = rep("reference", 204L),
    birth_rate = rep(
      c(
        0, 0.00041, 0.000808, 0.001581, 0.003418, 0.006455, 0.010405, 0.016157,
        0.02364, 0.032479, 0.042954, 0.055049, 0.068632, 0.083007, 0.09798, 0.111332,
        0.121122, 0.125879, 0.122941, 0.112803, 0.097161, 0.078333, 0.05944, 0.042398,
        0.028719, 0.018692, 0.011733, 0.006989, 0.00429, 0.00227, 0.001286, 0.000606,
        0.000277, 0.000262, 0, 0.001381, 0.005993, 0.017009, 0.032641, 0.048974,
        0.065594, 0.081725, 0.094398, 0.106007, 0.114386, 0.122848, 0.130621,
        0.134582, 0.136562, 0.134367, 0.129289, 0.120395, 0.109997, 0.096929,
        0.083624, 0.06944, 0.055859, 0.043528, 0.032069, 0.022818, 0.015167, 0.009358,
        0.005302, 0.002804, 0.001454, 0.000698, 0
      ),
      rep(c(68L, 1L, 69L, 1L, 3L), c(1L, 33L, 1L, 31L, 1L))
    ),
    births_int_ch = rep(0.23487796250442164, 204L),
    mor = c(
      0.004386, 0.000791, 0.000383, 0.000386, 0, 0, 0, 0, 0, 0, 0, 0.000388,
      0.000412, 0.000395, 0.000392, 0.000388, 0.000386, 0.000391, 0.00079, 0.00071,
      0.000726, 0.000702, 0.000683, 0.000661, 0.000348, 0.000342, 0.000328,
      0.000321, 0.000327, 0.000327, 0.000327, 0.000336, 0.00034, 0.000328, 0.000341,
      0.000641, 0.000661, 0.000653, 0.000655, 0.000655, 0.000675, 0.001045,
      0.001028, 0.001083, 0.001406, 0.001297, 0.001632, 0.001545, 0.001739, 0.00194,
      0.002162, 0.003348, 0.000417, 0.000401, 0.000393, 0, 0, 0, 0, 0, 0, 0, 0, 0,
      0, 0, 0, 0, 0, 0.000404, 0.000395, 0.00038, 0.00038, 0.000359, 0.000351,
      0.000348, 0.000342, 0.000349, 0.00032, 0.000333, 0.000327, 0.000337, 0.000331,
      0.000332, 0.000669, 0.000679, 0.000669, 0.000656, 0.000626, 0.000625,
      0.000662, 0.000668, 0.000692, 0.00067, 0.000635, 0.00066, 0.000972, 0.000964,
      0.000908, 0.001106, 0.001311, 0.001291, 0.003623, 0.000971, 0, 0, 0, 0, 0, 0,
      0, 0, 0, 0, 0, 0, 0, 0, 0.001172, 0.001214, 0.001293, 0.001206, 0.001205,
      0.001079, 0.001062, 0, 0, 0, 0, 0, 0, 0.000593, 0.00058, 0.000573, 0.000549,
      0.000551, 0.000522, 0.000507, 0.000512, 0.000484, 0.000488, 0.000503,
      0.000536, 0.001063, 0.001079, 0.001105, 0.00116, 0.001214, 0.001239, 0.001191,
      0.001889, 0.001958, 0.001905, 0.004766, 0.001051, 0, 0, 0, 0, 0, 0, 0, 0, 0,
      0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0.001037, 0, 0, 0.000782, 0.000714,
      0.000693, 0.000672, 0.000646, 0.000613, 0.000599, 0.000573, 0.000563,
      0.000581, 0.000574, 0.000576, 0.000573, 0.000617, 0.000617, 0.000659,
      0.000668, 0.000662, 0.000701, 0.000727, 0.000697, 0.000746, 0.000798,
      0.000772
    ),
    emi = c(
      0.002417, 0.005986, 0.005407, 0.005062, 0.004175, 0.004059, 0.003834,
      0.003114, 0.002681, 0.002278, 0.00199, 0.00156, 0.001244, 0.001193, 0.00079,
      0.000782, 0.000778, 0.000789, 0.001193, 0.001786, 0.002556, 0.003172,
      0.003429, 0.003974, 0.004538, 0.005137, 0.005242, 0.00544, 0.005559, 0.005556,
      0.005561, 0.0054, 0.005132, 0.005279, 0.004818, 0.00484, 0.004332, 0.004281,
      0.004292, 0.003966, 0.003747, 0.003512, 0.003452, 0.00364, 0.003541, 0.003262,
      0.003283, 0.003107, 0.002911, 0.002782, 0.002711, 0.003384, 0.003786,
      0.003641, 0.003566, 0.003604, 0.003329, 0.00334, 0.003236, 0.003353, 0.002756,
      0.002926, 0.002432, 0.002162, 0.002121, 0.002179, 0.001678, 0.001678,
      0.001656, 0.002037, 0.003183, 0.003053, 0.003053, 0.003241, 0.004228,
      0.004875, 0.005812, 0.006296, 0.006716, 0.007005, 0.006872, 0.006417,
      0.005988, 0.005667, 0.004715, 0.004447, 0.00371, 0.003305, 0.00284, 0.002521,
      0.002674, 0.002358, 0.002444, 0.002365, 0.002239, 0.002327, 0.002285,
      0.002265, 0.002435, 0.002222, 0.002368, 0.002332, 0.004513, 0.037073,
      0.032101, 0.02812, 0.025169, 0.022052, 0.018217, 0.016304, 0.014395, 0.01232,
      0.009395, 0.008841, 0.007495, 0.006593, 0.005214, 0.00454, 0.006993, 0.013269,
      0.020592, 0.026506, 0.030414, 0.034103, 0.039474, 0.040775, 0.041331,
      0.041978, 0.041897, 0.041014, 0.040028, 0.038532, 0.036949, 0.035882, 0.03427,
      0.033746, 0.032378, 0.031795, 0.031508, 0.030642, 0.029887, 0.029783,
      0.029602, 0.028769, 0.028108, 0.028208, 0.027891, 0.026204, 0.025466, 0.02503,
      0.024606, 0.023545, 0.022265, 0.012322, 0.043113, 0.034304, 0.02729, 0.02229,
      0.019211, 0.016649, 0.015091, 0.01427, 0.012948, 0.012821, 0.012155, 0.011312,
      0.010297, 0.01105, 0.010381, 0.010296, 0.010959, 0.01194, 0.014184, 0.016641,
      0.017808, 0.020752, 0.022754, 0.02623, 0.029851, 0.030387, 0.030057, 0.029477,
      0.029286, 0.029696, 0.028402, 0.028002, 0.026699, 0.025434, 0.023823,
      0.022209, 0.020196, 0.019075, 0.017222, 0.016079, 0.014833, 0.013898,
      0.012735, 0.011952, 0.011955, 0.010949, 0.011173, 0.010463, 0.010408,
      0.010062
    ),
    acq = c(
      0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
      0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
      0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
      0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
      0.023466, 0.012683, 0.015564, 0.015817, 0.016457, 0.017258, 0.017258,
      0.016304, 0.017274, 0.01848, 0.021921, 0.027505, 0.03212, 0.037363, 0.040667,
      0.044268, 0.041958, 0.039807, 0.034749, 0.03253, 0.027981, 0.022002, 0.01864,
      0.013252, 0.011089, 0.007463, 0.007905, 0.007457, 0.008427, 0.008563,
      0.010131, 0.011765, 0.012921, 0.014623, 0.015924, 0.016923, 0.017562,
      0.017996, 0.018128, 0.018173, 0.018299, 0.018114, 0.016757, 0.016593, 0.01627,
      0.015235, 0.014907, 0.014303, 0.01388, 0.013734, 0.012087, 0.014218, 0.015773,
      0.016632, 0.017544, 0.018237, 0.016178, 0.016649, 0.018109, 0.018661, 0.01992,
      0.020299, 0.022099, 0.024887, 0.033181, 0.040884, 0.051903, 0.059202,
      0.058904, 0.053731, 0.048227, 0.040847, 0.031507, 0.02594, 0.023952, 0.022951,
      0.021322, 0.019337, 0.017872, 0.016212, 0.016429, 0.015884, 0.017173,
      0.018046, 0.018204, 0.019653, 0.02042, 0.019871, 0.020196, 0.020809, 0.021814,
      0.022263, 0.021632, 0.02184, 0.022118, 0.021248, 0.020394, 0.019708, 0.018855,
      0.018685, 0.016813, 0.016254
    ),
    imm_int = c(
      2, 15, 15, 14, 13, 11, 10, 9, 8, 7, 6, 5, 4, 4, 3, 4, 4, 5, 6, 8, 9, 10, 12,
      13, 14, 15, 15, 15, 15, 15, 16, 15, 14, 14, 13, 13, 12, 12, 11, 11, 10, 10,
      10, 11, 12, 13, 13, 12, 12, 11, 10, 4, 13, 13, 12, 11, 10, 9, 9, 8, 7, 6, 5,
      5, 4, 4, 4, 5, 6, 6, 8, 11, 13, 14, 16, 16, 17, 17, 16, 15, 13, 13, 11, 10, 8,
      8, 7, 7, 8, 8, 8, 8, 8, 8, 8, 9, 9, 9, 9, 9, 9, 8, 23, 54, 51, 48, 47, 45, 44,
      43, 42, 42, 41, 40, 40, 38, 37, 34, 33, 32, 35, 45, 61, 84, 106, 128, 145,
      158, 166, 169, 169, 166, 161, 155, 148, 140, 132, 124, 117, 110, 103, 97, 91,
      86, 81, 76, 72, 68, 64, 60, 57, 54, 51, 20, 46, 42, 40, 39, 39, 38, 38, 38,
      39, 39, 39, 40, 39, 37, 36, 35, 36, 36, 46, 64, 87, 109, 128, 140, 145, 148,
      145, 141, 135, 128, 121, 113, 106, 99, 92, 85, 80, 74, 69, 64, 59, 56, 52, 49,
      46, 44, 42, 40, 38, 36
    ),
    mig_ch = c(
      17, 34, 26, 23, 16, 10, 7, 6, 2, 1, 2, 0, 1, 0, 1, 1, 2, 4, 6, 5, 6, 7, 5, 1,
      0, -7, -18, -19, -13, -10, -5, 8, 11, 12, 17, 16, 19, 19, 18, 17, 17, 16, 14,
      15, 12, 9, 10, 8, 7, 6, 5, 27, 22, 23, 19, 16, 13, 11, 7, 7, 5, 7, 7, 9, 9,
      10, 11, 10, 8, 4, 0, -3, 0, -4, -5, -13, -19, -10, -21, -8, -6, 2, 6, 6, 14,
      16, 15, 12, 13, 13, 18, 16, 16, 14, 12, 12, 12, 12, 9, 8, 6, 7, 2, 7, 10, 7,
      8, 7, 5, 4, 4, 5, 4, 4, 3, 2, 1, 1, 0, 1, 1, 3, 3, 3, 6, 5, 10, 11, 9, 13, 15,
      12, 13, 18, 16, 20, 20, 15, 15, 11, 10, 13, 12, 10, 9, 9, 10, 12, 9, 8, 10,
      10, 9, -1, 11, 11, 8, 6, 5, 4, 3, 4, 2, 3, 3, 3, 2, 3, 2, 3, 3, 3, -1, 0, 0,
      1, 3, 4, 8, 7, 9, 10, 13, 16, 17, 12, 12, 11, 10, 10, 10, 9, 8, 8, 8, 10, 9,
      8, 10, 10, 5, 5, 5, 3
    ),
    spatial_unit = rep("Aargau", 204L),
  )

  ## FSO population ----
  # fso_population |>
  #   dplyr::filter(age < 51) |>
  #   constructive::construct()
  population_short_1r <- tibble::tibble(
    year = rep("2018", 204L),
    spatial_unit = rep("Aargau", 204L),
    nat = rep(c("ch", "int"), each = 102L),
    sex = rep(rep(c("m", "f"), 2), each = 51L),
    age = rep(seq(0, 50, by = 1), 4),
    n = c(
      2506, 2589, 2568, 2635, 2710, 2608, 2569, 2611, 2634, 2512,
      2564, 2411, 2514, 2531, 2559, 2571, 2535, 2515, 2799, 2739, 2837,
      2916, 3020, 2865, 2920, 3052, 3125, 3058, 3060, 3057, 2963, 2923,
      3031, 2906, 3099, 3001, 3037, 3029, 3026, 2936, 2847, 2897, 2747,
      2824, 3066, 3046, 3219, 3435, 3595, 3689, 4001, 2377, 2472, 2524,
      2497, 2403, 2395, 2472, 2386, 2540, 2392, 2467, 2313, 2357, 2295,
      2384, 2384, 2415, 2454, 2513, 2620, 2620, 2777, 2838, 2872, 2925,
      2859, 3127, 2998, 3056, 2961, 3006, 3000, 2969, 2923, 2965, 3026,
      3169, 3173, 2992, 2969, 2864, 2960, 3126, 3008, 3064, 3091, 3285,
      3601, 3801, 3859, 4113, 1025, 1028, 1138, 1033, 1043, 1043, 1104,
      1042, 974, 958, 1018, 934, 910, 959, 881, 858, 829, 777, 830,
      822, 909, 912, 981, 992, 1072, 1265, 1341, 1424, 1635, 1678,
      1700, 1780, 1778, 1884, 1950, 1936, 2056, 2041, 1981, 1858, 1877,
      1850, 1808, 1721, 1641, 1610, 1678, 1585, 1529, 1572, 1503, 951,
      962, 1026, 987, 989, 961, 994, 911, 1004, 936, 905, 884, 874,
      905, 867, 777, 730, 670, 705, 661, 730, 771, 835, 915, 938, 1086,
      1231, 1357, 1400, 1448, 1514, 1607, 1648, 1730, 1763, 1711, 1733,
      1730, 1742, 1617, 1618, 1511, 1492, 1506, 1422, 1370, 1432, 1338,
      1249, 1292, 1224
    ),
  )

  ## Run propop with 1 region ----
  output_propop_1r <- propop(
    parameters = parameters_short_1r,
    year_first = 2019,
    year_last = 2019,
    age_groups = 51,
    fert_first = 16,
    fert_last = 50,
    share_born_female = 100 / 205,
    population = population_short_1r,
    binational = TRUE,
    subregional = FALSE
  )

  # Run snapshot 1 region ----
  expect_snapshot(constructive::construct(output_propop_1r))


  # Prepare snapshot for subregions -----

  ## FSO parameters with fictitious subregions ----
  # fso_parameters |>
  #   dplyr::filter(age < 51 & year == 2019) |>
  #   # Create fictitious intra-cantonal migration parameter
  #   dplyr::rowwise() |>
  #   dplyr::mutate(
  #     mig_sub_1 = {set.seed(1); round(rnorm(1, mean = 0, sd = 0.2), digits = 4)},
  #     mig_sub_2 = {set.seed(2);round(rnorm(1, mean = 0, sd = 0.2), digits = 4)},
  #     mig_sub_3 = {set.seed(3);round(rnorm(1, mean = 0, sd = 0.2), digits = 4)},
  #     mig_sub_4 = {set.seed(4);round(rnorm(1, mean = 0, sd = 0.2), digits = 4)},
  #     mig_sub_5 = 0 - sum(mig_sub_1, mig_sub_2,mig_sub_3,mig_sub_4)
  #     # check = sum(mig_sub_1, mig_sub_2,mig_sub_3,mig_sub_4,mig_sub_5)
  #   ) |>
  #   pivot_longer(mig_sub_1:mig_sub_5,
  #                names_to = "subregion",
  #                values_to = "mig_sub") |>
  #   dplyr::mutate(spatial_unit = as.character(stringr::str_extract(subregion, "(?<=mig_sub_).*"))) |>
  #   # divide the size of parameters with numbers by the number of regions (=5),
  #   # otherwise the multiplication of lines inflates the size of the population
  #   dplyr::mutate_at(vars(imm_int, mig_ch), ~ ./5) |>
  #   dplyr::select(-subregion) |>
  #   constructive::construct()

  parameters_short_5r <- tibble::tibble(
    nat = rep(c("ch", "int"), each = 510L),
    sex = rep(rep(c("m", "f"), 2), each = 255L),
    age = rep(rep(seq(0, 50, by = 1), 4), each = 5L),
    year = rep("2019", 1020L),
    scen = rep("reference", 1020L),
    birth_rate = rep(
      c(
        0, 0.00041, 0.000808, 0.001581, 0.003418, 0.006455, 0.010405, 0.016157,
        0.02364, 0.032479, 0.042954, 0.055049, 0.068632, 0.083007, 0.09798, 0.111332,
        0.121122, 0.125879, 0.122941, 0.112803, 0.097161, 0.078333, 0.05944, 0.042398,
        0.028719, 0.018692, 0.011733, 0.006989, 0.00429, 0.00227, 0.001286, 0.000606,
        0.000277, 0.000262, 0, 0.001381, 0.005993, 0.017009, 0.032641, 0.048974,
        0.065594, 0.081725, 0.094398, 0.106007, 0.114386, 0.122848, 0.130621,
        0.134582, 0.136562, 0.134367, 0.129289, 0.120395, 0.109997, 0.096929,
        0.083624, 0.06944, 0.055859, 0.043528, 0.032069, 0.022818, 0.015167, 0.009358,
        0.005302, 0.002804, 0.001454, 0.000698, 0
      ),
      rep(c(340L, 5L, 345L, 5L, 15L), c(1L, 33L, 1L, 31L, 1L))
    ),
    births_int_ch = rep(0.23487796250442164, 1020L),
    mor = rep(
      c(
        0.004386, 0.000791, 0.000383, 0.000386, 0, 0.000388, 0.000412, 0.000395,
        0.000392, 0.000388, 0.000386, 0.000391, 0.00079, 0.00071, 0.000726, 0.000702,
        0.000683, 0.000661, 0.000348, 0.000342, 0.000328, 0.000321, 0.000327,
        0.000336, 0.00034, 0.000328, 0.000341, 0.000641, 0.000661, 0.000653, 0.000655,
        0.000675, 0.001045, 0.001028, 0.001083, 0.001406, 0.001297, 0.001632,
        0.001545, 0.001739, 0.00194, 0.002162, 0.003348, 0.000417, 0.000401, 0.000393,
        0, 0.000404, 0.000395, 0.00038, 0.000359, 0.000351, 0.000348, 0.000342,
        0.000349, 0.00032, 0.000333, 0.000327, 0.000337, 0.000331, 0.000332, 0.000669,
        0.000679, 0.000669, 0.000656, 0.000626, 0.000625, 0.000662, 0.000668,
        0.000692, 0.00067, 0.000635, 0.00066, 0.000972, 0.000964, 0.000908, 0.001106,
        0.001311, 0.001291, 0.003623, 0.000971, 0, 0.001172, 0.001214, 0.001293,
        0.001206, 0.001205, 0.001079, 0.001062, 0, 0.000593, 0.00058, 0.000573,
        0.000549, 0.000551, 0.000522, 0.000507, 0.000512, 0.000484, 0.000488,
        0.000503, 0.000536, 0.001063, 0.001079, 0.001105, 0.00116, 0.001214, 0.001239,
        0.001191, 0.001889, 0.001958, 0.001905, 0.004766, 0.001051, 0, 0.001037, 0,
        0.000782, 0.000714, 0.000693, 0.000672, 0.000646, 0.000613, 0.000599,
        0.000573, 0.000563, 0.000581, 0.000574, 0.000576, 0.000573, 0.000617,
        0.000659, 0.000668, 0.000662, 0.000701, 0.000727, 0.000697, 0.000746,
        0.000798, 0.000772
      ),
      rep(
        c(
          5L, 35L, 5L, 15L, 5L, 10L, 5L, 70L, 5L, 10L, 5L, 70L, 5L, 30L,
          5L, 110L, 5L, 10L, 5L, 10L, 5L
        ),
        c(
          4L, 1L, 17L, 1L, 7L, 1L, 15L, 1L, 2L, 1L, 31L, 1L, 7L, 1L,
          24L, 1L, 1L, 1L, 13L, 1L, 9L
        )
      )
    ),
    emi = rep(
      c(
        0.002417, 0.005986, 0.005407, 0.005062, 0.004175, 0.004059, 0.003834,
        0.003114, 0.002681, 0.002278, 0.00199, 0.00156, 0.001244, 0.001193, 0.00079,
        0.000782, 0.000778, 0.000789, 0.001193, 0.001786, 0.002556, 0.003172,
        0.003429, 0.003974, 0.004538, 0.005137, 0.005242, 0.00544, 0.005559, 0.005556,
        0.005561, 0.0054, 0.005132, 0.005279, 0.004818, 0.00484, 0.004332, 0.004281,
        0.004292, 0.003966, 0.003747, 0.003512, 0.003452, 0.00364, 0.003541, 0.003262,
        0.003283, 0.003107, 0.002911, 0.002782, 0.002711, 0.003384, 0.003786,
        0.003641, 0.003566, 0.003604, 0.003329, 0.00334, 0.003236, 0.003353, 0.002756,
        0.002926, 0.002432, 0.002162, 0.002121, 0.002179, 0.001678, 0.001656,
        0.002037, 0.003183, 0.003053, 0.003241, 0.004228, 0.004875, 0.005812,
        0.006296, 0.006716, 0.007005, 0.006872, 0.006417, 0.005988, 0.005667,
        0.004715, 0.004447, 0.00371, 0.003305, 0.00284, 0.002521, 0.002674, 0.002358,
        0.002444, 0.002365, 0.002239, 0.002327, 0.002285, 0.002265, 0.002435,
        0.002222, 0.002368, 0.002332, 0.004513, 0.037073, 0.032101, 0.02812, 0.025169,
        0.022052, 0.018217, 0.016304, 0.014395, 0.01232, 0.009395, 0.008841, 0.007495,
        0.006593, 0.005214, 0.00454, 0.006993, 0.013269, 0.020592, 0.026506, 0.030414,
        0.034103, 0.039474, 0.040775, 0.041331, 0.041978, 0.041897, 0.041014,
        0.040028, 0.038532, 0.036949, 0.035882, 0.03427, 0.033746, 0.032378, 0.031795,
        0.031508, 0.030642, 0.029887, 0.029783, 0.029602, 0.028769, 0.028108,
        0.028208, 0.027891, 0.026204, 0.025466, 0.02503, 0.024606, 0.023545, 0.022265,
        0.012322, 0.043113, 0.034304, 0.02729, 0.02229, 0.019211, 0.016649, 0.015091,
        0.01427, 0.012948, 0.012821, 0.012155, 0.011312, 0.010297, 0.01105, 0.010381,
        0.010296, 0.010959, 0.01194, 0.014184, 0.016641, 0.017808, 0.020752, 0.022754,
        0.02623, 0.029851, 0.030387, 0.030057, 0.029477, 0.029286, 0.029696, 0.028402,
        0.028002, 0.026699, 0.025434, 0.023823, 0.022209, 0.020196, 0.019075,
        0.017222, 0.016079, 0.014833, 0.013898, 0.012735, 0.011952, 0.011955,
        0.010949, 0.011173, 0.010463, 0.010408, 0.010062
      ),
      rep(c(5L, 10L, 5L, 10L, 5L), c(66L, 1L, 3L, 1L, 131L))
    ),
    acq = rep(
      c(
        0, 0.023466, 0.012683, 0.015564, 0.015817, 0.016457, 0.017258, 0.016304,
        0.017274, 0.01848, 0.021921, 0.027505, 0.03212, 0.037363, 0.040667, 0.044268,
        0.041958, 0.039807, 0.034749, 0.03253, 0.027981, 0.022002, 0.01864, 0.013252,
        0.011089, 0.007463, 0.007905, 0.007457, 0.008427, 0.008563, 0.010131,
        0.011765, 0.012921, 0.014623, 0.015924, 0.016923, 0.017562, 0.017996,
        0.018128, 0.018173, 0.018299, 0.018114, 0.016757, 0.016593, 0.01627, 0.015235,
        0.014907, 0.014303, 0.01388, 0.013734, 0.012087, 0.014218, 0.015773, 0.016632,
        0.017544, 0.018237, 0.016178, 0.016649, 0.018109, 0.018661, 0.01992, 0.020299,
        0.022099, 0.024887, 0.033181, 0.040884, 0.051903, 0.059202, 0.058904,
        0.053731, 0.048227, 0.040847, 0.031507, 0.02594, 0.023952, 0.022951, 0.021322,
        0.019337, 0.017872, 0.016212, 0.016429, 0.015884, 0.017173, 0.018046,
        0.018204, 0.019653, 0.02042, 0.019871, 0.020196, 0.020809, 0.021814, 0.022263,
        0.021632, 0.02184, 0.022118, 0.021248, 0.020394, 0.019708, 0.018855, 0.018685,
        0.016813, 0.016254
      ),
      rep(c(510L, 5L, 10L, 5L), c(1L, 5L, 1L, 95L))
    ),
    imm_int = rep(
      c(
        0.4, 3, 2.8, 2.6, 2.2, 2, 1.8, 1.6, 1.4, 1.2, 1, 0.8, 0.6, 0.8, 1, 1.2, 1.6,
        1.8, 2, 2.4, 2.6, 2.8, 3, 3.2, 3, 2.8, 2.6, 2.4, 2.2, 2, 2.2, 2.4, 2.6, 2.4,
        2.2, 2, 0.8, 2.6, 2.4, 2.2, 2, 1.8, 1.6, 1.4, 1.2, 1, 0.8, 1, 1.2, 1.6, 2.2,
        2.6, 2.8, 3.2, 3.4, 3.2, 3, 2.6, 2.2, 2, 1.6, 1.4, 1.6, 1.8, 1.6, 4.6, 10.8,
        10.2, 9.6, 9.4, 9, 8.8, 8.6, 8.4, 8.2, 8, 7.6, 7.4, 6.8, 6.6, 6.4, 7, 9, 12.2,
        16.8, 21.2, 25.6, 29, 31.6, 33.2, 33.8, 33.2, 32.2, 31, 29.6, 28, 26.4, 24.8,
        23.4, 22, 20.6, 19.4, 18.2, 17.2, 16.2, 15.2, 14.4, 13.6, 12.8, 12, 11.4,
        10.8, 10.2, 4, 9.2, 8.4, 8, 7.8, 7.6, 7.8, 8, 7.8, 7.4, 7.2, 7, 7.2, 9.2,
        12.8, 17.4, 21.8, 25.6, 28, 29, 29.6, 29, 28.2, 27, 25.6, 24.2, 22.6, 21.2,
        19.8, 18.4, 17, 16, 14.8, 13.8, 12.8, 11.8, 11.2, 10.4, 9.8, 9.2, 8.8, 8.4, 8,
        7.6, 7.2
      ),
      rep(
        c(
          5L, 10L, 5L, 10L, 5L, 10L, 5L, 25L, 5L, 10L, 15L, 5L, 10L,
          5L, 10L, 5L, 10L, 5L, 10L, 15L, 5L, 10L, 5L, 10L, 5L, 10L, 5L,
          10L, 35L, 30L, 5L, 10L, 5L, 10L, 5L, 10L, 5L, 10L, 15L, 5L, 10L,
          5L
        ),
        c(
          1L, 1L, 9L, 1L, 1L, 1L, 8L, 1L, 2L, 4L, 1L, 2L, 2L, 3L, 1L,
          3L, 1L, 3L, 1L, 1L, 1L, 1L, 4L, 2L, 2L, 1L, 2L, 2L, 1L, 1L, 9L,
          1L, 1L, 1L, 14L, 1L, 26L, 1L, 2L, 5L, 1L, 32L
        )
      )
    ),
    mig_ch = rep(
      c(
        3.4, 6.8, 5.2, 4.6, 3.2, 2, 1.4, 1.2, 0.4, 0.2, 0.4, 0, 0.2, 0, 0.2, 0.4, 0.8,
        1.2, 1, 1.2, 1.4, 1, 0.2, 0, -1.4, -3.6, -3.8, -2.6, -2, -1, 1.6, 2.2, 2.4,
        3.4, 3.2, 3.8, 3.6, 3.4, 3.2, 2.8, 3, 2.4, 1.8, 2, 1.6, 1.4, 1.2, 1, 5.4, 4.4,
        4.6, 3.8, 3.2, 2.6, 2.2, 1.4, 1, 1.4, 1.8, 2, 2.2, 2, 1.6, 0.8, 0, -0.6, 0,
        -0.8, -1, -2.6, -3.8, -2, -4.2, -1.6, -1.2, 0.4, 1.2, 2.8, 3.2, 3, 2.4, 2.6,
        3.6, 3.2, 2.8, 2.4, 1.8, 1.6, 1.2, 1.4, 0.4, 1.4, 2, 1.4, 1.6, 1.4, 1, 0.8, 1,
        0.8, 0.6, 0.4, 0.2, 0, 0.2, 0.6, 1.2, 1, 2, 2.2, 1.8, 2.6, 3, 2.4, 2.6, 3.6,
        3.2, 4, 3, 2.2, 2, 2.6, 2.4, 2, 1.8, 2, 2.4, 1.8, 1.6, 2, 1.8, -0.2, 2.2, 1.6,
        1.2, 1, 0.8, 0.6, 0.8, 0.4, 0.6, 0.4, 0.6, 0.4, 0.6, -0.2, 0, 0.2, 0.6, 0.8,
        1.6, 1.4, 1.8, 2, 2.6, 3.2, 3.4, 2.4, 2.2, 2, 1.8, 1.6, 2, 1.8, 1.6, 2, 1,
        0.6
      ),
      rep(
        c(
          5L, 10L, 5L, 10L, 5L, 10L, 5L, 10L, 5L, 10L, 5L, 10L, 5L, 10L,
          5L, 10L, 5L, 20L, 5L, 10L, 5L, 10L, 5L, 10L, 5L, 10L, 15L, 5L,
          10L, 5L, 10L, 5L, 10L, 5L, 10L, 5L, 15L, 5L, 15L, 5L, 10L, 5L,
          10L, 5L, 15L, 5L, 15L, 5L, 10L, 15L, 5L
        ),
        c(
          14L, 1L, 20L, 1L, 1L, 1L, 17L, 1L, 1L, 2L, 17L, 1L, 4L, 1L,
          1L, 1L, 1L, 1L, 11L, 1L, 1L, 1L, 2L, 1L, 1L, 1L, 1L, 11L, 2L,
          5L, 1L, 4L, 1L, 2L, 1L, 7L, 1L, 3L, 1L, 1L, 1L, 10L, 1L, 1L,
          1L, 1L, 1L, 3L, 1L, 1L, 1L
        )
      )
    ),
    spatial_unit = rep(c("1", "2", "3", "4", "5"), 204),
    mig_sub = rep(c(-0.1253, -0.1794, -0.1924, 0.0434, 0.4537), 204),
  )

  ## FSO population with fictitious subregions ----
  # fso_population |>
  #   dplyr::rename(n_tot = n) |>
  #   # duplicating rows 5 times
  #   tidyr::uncount(5) |>
  #   # create 5 subregions
  #   dplyr::mutate(spatial_unit = rep(1:5, times = nrow(fso_population))) |>
  #   dplyr::mutate(
  #     # Create fictitious n
  #     n = case_match(
  #       spatial_unit,
  #       1 ~ round(n_tot * 0.3),
  #       2 ~ round(n_tot * 0.25),
  #       3 ~ round(n_tot * 0.2),
  #       4 ~ round(n_tot * 0.15),
  #       # 5 ~ round(n_tot * 0.1),
  #       .default = NA
  #     ),
  #     .keep = "all"
  #   ) |>
  #   # create region 5 by subtracting sum of 1:4 from original n to get exact same n
  #   # (avoid rounding errors)
  #   ## get sum of regions 1-4
  #   dplyr::mutate(sum = sum(n, na.rm = TRUE), .by=c(year,nat,sex,age)) |>
  #   ## compute region 5
  #   dplyr::mutate(
  #     n = case_match(
  #       spatial_unit,
  #       5 ~ (n_tot - sum),
  #       .default = n
  #     )) |>
  #   dplyr::mutate(spatial_unit = as.character(spatial_unit)) |>
  #   dplyr::select(-n_tot, -sum) |>
  #   dplyr::filter(age < 51) |>
  #   constructive::construct()

  population_short_5r <- tibble::tibble(
    year = rep("2018", 1020L),
    spatial_unit = rep(c("1", "2", "3", "4", "5"), 204),
    nat = rep(c("ch", "int"), each = 510L),
    sex = rep(rep(c("m", "f"), 2), each = 255L),
    age = rep(rep(seq(0, 50, by = 1), 4), each = 5L),
    n = c(
      752, 626, 501, 376, 251, 777, 647, 518, 388, 259, 770, 642,
      514, 385, 257, 790, 659, 527, 395, 264, 813, 678, 542, 406, 271,
      782, 652, 522, 391, 261, 771, 642, 514, 385, 257, 783, 653, 522,
      392, 261, 790, 658, 527, 395, 264, 754, 628, 502, 377, 251, 769,
      641, 513, 385, 256, 723, 603, 482, 362, 241, 754, 628, 503, 377,
      252, 759, 633, 506, 380, 253, 768, 640, 512, 384, 255, 771, 643,
      514, 386, 257, 760, 634, 507, 380, 254, 754, 629, 503, 377, 252,
      840, 700, 560, 420, 279, 822, 685, 548, 411, 273, 851, 709, 567,
      426, 284, 875, 729, 583, 437, 292, 906, 755, 604, 453, 302, 860,
      716, 573, 430, 286, 876, 730, 584, 438, 292, 916, 763, 610, 458,
      305, 938, 781, 625, 469, 312, 917, 764, 612, 459, 306, 918, 765,
      612, 459, 306, 917, 764, 611, 459, 306, 889, 741, 593, 444, 296,
      877, 731, 585, 438, 292, 909, 758, 606, 455, 303, 872, 726, 581,
      436, 291, 930, 775, 620, 465, 309, 900, 750, 600, 450, 301, 911,
      759, 607, 456, 304, 909, 757, 606, 454, 303, 908, 756, 605, 454,
      303, 881, 734, 587, 440, 294, 854, 712, 569, 427, 285, 869, 724,
      579, 435, 290, 824, 687, 549, 412, 275, 847, 706, 565, 424, 282,
      920, 766, 613, 460, 307, 914, 762, 609, 457, 304, 966, 805, 644,
      483, 321, 1030, 859, 687, 515, 344, 1078, 899, 719, 539, 360,
      1107, 922, 738, 553, 369, 1200, 1000, 800, 600, 401, 713, 594,
      475, 357, 238, 742, 618, 494, 371, 247, 757, 631, 505, 379, 252,
      749, 624, 499, 375, 250, 721, 601, 481, 360, 240, 718, 599, 479,
      359, 240, 742, 618, 494, 371, 247, 716, 596, 477, 358, 239, 762,
      635, 508, 381, 254, 718, 598, 478, 359, 239, 740, 617, 493, 370,
      247, 694, 578, 463, 347, 231, 707, 589, 471, 354, 236, 688, 574,
      459, 344, 230, 715, 596, 477, 358, 238, 715, 596, 477, 358, 238,
      724, 604, 483, 362, 242, 736, 614, 491, 368, 245, 754, 628, 503,
      377, 251, 786, 655, 524, 393, 262, 786, 655, 524, 393, 262, 833,
      694, 555, 417, 278, 851, 710, 568, 426, 283, 862, 718, 574, 431,
      287, 878, 731, 585, 439, 292, 858, 715, 572, 429, 285, 938, 782,
      625, 469, 313, 899, 750, 600, 450, 299, 917, 764, 611, 458, 306,
      888, 740, 592, 444, 297, 902, 752, 601, 451, 300, 900, 750, 600,
      450, 300, 891, 742, 594, 445, 297, 877, 731, 585, 438, 292, 890,
      741, 593, 445, 296, 908, 756, 605, 454, 303, 951, 792, 634, 475,
      317, 952, 793, 635, 476, 317, 898, 748, 598, 449, 299, 891, 742,
      594, 445, 297, 859, 716, 573, 430, 286, 888, 740, 592, 444, 296,
      938, 782, 625, 469, 312, 902, 752, 602, 451, 301, 919, 766, 613,
      460, 306, 927, 773, 618, 464, 309, 986, 821, 657, 493, 328, 1080,
      900, 720, 540, 361, 1140, 950, 760, 570, 381, 1158, 965, 772,
      579, 385, 1234, 1028, 823, 617, 411, 308, 256, 205, 154, 102,
      308, 257, 206, 154, 103, 341, 284, 228, 171, 114, 310, 258, 207,
      155, 103, 313, 261, 209, 156, 104, 313, 261, 209, 156, 104, 331,
      276, 221, 166, 110, 313, 260, 208, 156, 105, 292, 244, 195, 146,
      97, 287, 240, 192, 144, 95, 305, 254, 204, 153, 102, 280, 234,
      187, 140, 93, 273, 228, 182, 136, 91, 288, 240, 192, 144, 95,
      264, 220, 176, 132, 89, 257, 214, 172, 129, 86, 249, 207, 166,
      124, 83, 233, 194, 155, 117, 78, 249, 208, 166, 124, 83, 247,
      206, 164, 123, 82, 273, 227, 182, 136, 91, 274, 228, 182, 137,
      91, 294, 245, 196, 147, 99, 298, 248, 198, 149, 99, 322, 268,
      214, 161, 107, 380, 316, 253, 190, 126, 402, 335, 268, 201, 135,
      427, 356, 285, 214, 142, 490, 409, 327, 245, 164, 503, 420, 336,
      252, 167, 510, 425, 340, 255, 170, 534, 445, 356, 267, 178, 533,
      444, 356, 267, 178, 565, 471, 377, 283, 188, 585, 488, 390, 292,
      195, 581, 484, 387, 290, 194, 617, 514, 411, 308, 206, 612, 510,
      408, 306, 205, 594, 495, 396, 297, 199, 557, 464, 372, 279, 186,
      563, 469, 375, 282, 188, 555, 462, 370, 278, 185, 542, 452, 362,
      271, 181, 516, 430, 344, 258, 173, 492, 410, 328, 246, 165, 483,
      402, 322, 242, 161, 503, 420, 336, 252, 167, 476, 396, 317, 238,
      158, 459, 382, 306, 229, 153, 472, 393, 314, 236, 157, 451, 376,
      301, 225, 150, 285, 238, 190, 143, 95, 289, 240, 192, 144, 97,
      308, 256, 205, 154, 103, 296, 247, 197, 148, 99, 297, 247, 198,
      148, 99, 288, 240, 192, 144, 97, 298, 248, 199, 149, 100, 273,
      228, 182, 137, 91, 301, 251, 201, 151, 100, 281, 234, 187, 140,
      94, 272, 226, 181, 136, 90, 265, 221, 177, 133, 88, 262, 218,
      175, 131, 88, 272, 226, 181, 136, 90, 260, 217, 173, 130, 87,
      233, 194, 155, 117, 78, 219, 182, 146, 110, 73, 201, 168, 134,
      100, 67, 212, 176, 141, 106, 70, 198, 165, 132, 99, 67, 219,
      182, 146, 110, 73, 231, 193, 154, 116, 77, 250, 209, 167, 125,
      84, 274, 229, 183, 137, 92, 281, 234, 188, 141, 94, 326, 272,
      217, 163, 108, 369, 308, 246, 185, 123, 407, 339, 271, 204, 136,
      420, 350, 280, 210, 140, 434, 362, 290, 217, 145, 454, 378, 303,
      227, 152, 482, 402, 321, 241, 161, 494, 412, 330, 247, 165, 519,
      432, 346, 260, 173, 529, 441, 353, 264, 176, 513, 428, 342, 257,
      171, 520, 433, 347, 260, 173, 519, 432, 346, 260, 173, 523, 436,
      348, 261, 174, 485, 404, 323, 243, 162, 485, 404, 324, 243, 162,
      453, 378, 302, 227, 151, 448, 373, 298, 224, 149, 452, 376, 301,
      226, 151, 427, 356, 284, 213, 142, 411, 342, 274, 206, 137, 430,
      358, 286, 215, 143, 401, 334, 268, 201, 134, 375, 312, 250, 187,
      125, 388, 323, 258, 194, 129, 367, 306, 245, 184, 122
    ),
  )

  # run propop 5 regions ----
  output_propop_5r <- propop(
    parameters = parameters_short_5r,
    year_first = 2019,
    year_last = 2019,
    age_groups = 51,
    fert_first = 16,
    fert_last = 50,
    share_born_female = 100 / 205,
    population = population_short_5r,
    binational = TRUE,
    subregional = TRUE
  )

  # run snapshot 5 subregions ----
  expect_snapshot(constructive::construct(output_propop_5r))

  # prepare comparison 1 vs 5 regions ----

  ## prepare data for comparison ----
  ### n in starting populations should be identical in both versions
  ### simplify to make comparable
  compare_pop1r <- population_short_1r |>
    select(-spatial_unit) |>
    arrange(year, nat, sex, age)
  ### simplify to make comparable
  compare_pop5r <- population_short_5r |>
    summarise(n = sum(n), .by = c(year, nat, sex, age)) |>
    arrange(year, nat, sex, age)



  # run equal starting populations ----
  expect_equal(compare_pop1r, compare_pop5r)


  ### parameters should be identical in both versions
  compare_params_1r <- parameters_short_1r |>
    dplyr::select(-spatial_unit) |>
    arrange(year, nat, sex, age)

  compare_params_5r <- parameters_short_5r |>
    # remove column that includes redundancy
    dplyr::select(-mig_sub, -spatial_unit) |>
    # remove redundant columns
    dplyr::distinct(year, nat, sex, age, .keep_all = TRUE) |>
    # multiply columns with number-of-people parameters
    # by number of regions to get the n right again
    dplyr::mutate_at(vars(imm_int, mig_ch), ~ . * 5) |>
    arrange(year, nat, sex, age)

  # run equal parameters ----
  expect_equal(compare_params_1r, compare_params_5r)


  ## equal projection results
  # simplify data for comparison
  output_super <- output_propop_1r |>
    select(year, age, sex, nat, n) |>
    arrange(year, nat, sex, age)

  output_subregions <- output_propop_5r |>
    dplyr::mutate(n_check = sum(n, na.rm = TRUE), .by = c(year, nat, sex, age)) |>
    # remove column that includes redundancy
    dplyr::select(-n, -spatial_unit) |>
    # rename n_check
    rename(n = n_check) |>
    # remove redundant columns
    dplyr::distinct(year, nat, sex, age, .keep_all = TRUE) |>
    select(year, age, sex, nat, n) |>
    arrange(year, nat, sex, age)

  # run equal output ----
  expect_equal(output_super, output_subregions, ignore_attr = TRUE)
})

options(cli.default_handler = NULL)



# Unexpected input regarding nationalities ----

test_that("Error when binational is FALSE but column `nat` is present", {
  expect_error(
    propop(
      parameters = fso_parameters,
      year_first = 2019,
      year_last = 2020,
      fert_first = 16,
      fert_last = 50,
      share_born_female = 100 / 205,
      population = fso_population,
      binational = FALSE,
      subregional = FALSE
    )
  )
})

test_that("Error when binational is not provided", {
  expect_error(
    propop(
      parameters = fso_parameters,
      year_first = 2019,
      year_last = 2020,
      fert_first = 16,
      fert_last = 50,
      share_born_female = 100 / 205,
      population = fso_population,
      subregional = FALSE
    )
  )
})

test_that("Error when only 1 nationality in parameters", {
  expect_error(
    propop(
      # remove non-Swiss nationals
      parameters = fso_parameters |>
        # remove non-Swiss nationals
        dplyr::filter(nat != "int"),
      year_first = 2019,
      year_last = 2020,
      fert_first = 16,
      fert_last = 50,
      share_born_female = 100 / 205,
      population = fso_population,
      binational = TRUE,
      subregional = FALSE
    )
  )
})

test_that("Error when only 1 nationality in population", {
  expect_error(
    propop(
      # remove non-Swiss nationals
      parameters = fso_parameters,
      year_first = 2019,
      year_last = 2020,
      fert_first = 16,
      fert_last = 50,
      share_born_female = 100 / 205,
      population = fso_population |>
        # remove Swiss nationals
        dplyr::filter(nat == "int"),
      binational = TRUE,
      subregional = FALSE
    )
  )
})

test_that("Error if there are unexpected factor levels in pop `nat`", {
  expect_error(
    propop(
      # remove non-Swiss nationals
      parameters = fso_parameters,
      year_first = 2019,
      year_last = 2020,
      fert_first = 16,
      fert_last = 50,
      share_born_female = 100 / 205,
      population = fso_population |>
        # replace factor level
        dplyr::mutate(nat = case_match(
          nat,
          "ch" ~ "swiss",
          .default = nat)),
      binational = TRUE,
      subregional = FALSE
    )
  )
})
