test_that("Snapshot 1-year age classes", {

  skip_on_ci()

  input <- tibble::tibble(
    year = rep(2020L, 4L),
    spatial_unit = rep("Aargau", 4L),
    nat = rep(c("ch", "int"), each = 2L),
    sex = rep(c("m", "f"), 2),
    age = seq(0, 3, by = 1),
    n_bench = c(2605, 2679, 2650, 2688),
    n_proj = c(2526, 2558, 2594, 2667),
    error = c(-79, -121, -56, -21),
    perc_e = c(-3.032629558541267, -4.516610675625234, -2.1132, -0.78125),
    abs_perc_e = c(3.03, 4.516610675625234, 2.1132075471698113, 0.78125),
  )

  output <- aggregate_measures(input)

  expect_snapshot(dput(output))
})


test_that("Snapshot 3 age classes", {

  skip_on_ci()

  input2 <- tibble::tibble(
    year = rep(2020L, 12L),
    spatial_unit = rep("Aargau", 12L),
    age = rep(c("age_00_19", "age_20_64", "age_65_"), each = 4L),
    sex = rep(rep(c("f", "m"), 3), each = 2L),
    nat = rep(c("ch", "int"), 6),
    n_bench = c(50020, 17917, 53005, 19501, 152176, 57480, 149723, 68082, 61030, 6635, 51061, 7442),
    n_proj = c(49691, 18519, 52395, 19944, 151735, 57722, 149453, 68452, 61394, 6700, 51710, 7616),
    error = c(-329, 602, -610, 443, -441, 242, -270, 370, 364, 65, 649, 174),
    perc_e = c(
      -0.6577369052379048, 3.359937489535078, -1.1508348269031223,
      2.271678375467925, -0.2897960256545053, 0.4210160055671538,
      -0.18033301496764026, 0.5434622954672307, 0.5964279862362772,
      0.9796533534287867, 1.271028769510977, 2.3380811609782315
    ),
    abs_perc_e = c(
      0.6577369052379048, 3.359937489535078, 1.1508348269031223, 2.271678375467925,
      0.2897960256545053, 0.4210160055671538, 0.18033301496764026,
      0.5434622954672307, 0.5964279862362772, 0.9796533534287867, 1.271028769510977,
      2.3380811609782315
    ),
    n_tot = rep(694072, 12L),
    group_tot = c(
      103025, 37418, 103025, 37418, 301899, 125562, 301899, 125562, 112091, 14077,
      112091, 14077
    ),
    weight = c(
      0.14843560898581126, 0.0539108334582003, 0.14843560898581126,
      0.0539108334582003, 0.4349678419529962, 0.18090630366878363,
      0.4349678419529962, 0.18090630366878363, 0.1614976544220196,
      0.020281757512188938, 0.1614976544220196, 0.020281757512188938
    ),
    w_abs_perc_e = c(
      0.09763157808143123, 0.18113703042828921, 0.17082486837344565,
      0.12246807457044631, 0.12605195188549528, 0.07616444935254982,
      0.07843906235335185, 0.09831575505632904, 0.09632172080880737,
      0.01986909176024538, 0.20526816497892858, 0.04742039515077768
    ),
  )

  output2 <- aggregate_measures(input2, weight_groups = c("age", "nat"))

  expect_snapshot(dput(output2))

})


